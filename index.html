<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="js/socket.io.js"></script>
    <script src="js/client.js"></script>
  <script>
    window.onload = () => {
      document.getElementById('send').disabled=true;
      document.getElementById('details').addEventListener('submit', (event) => {
        event.preventDefault();
        const from = document.getElementById('from');
        const to = document.getElementById('to');
        from.disabled=true;
        to.disabled=true;
        document.getElementById('set-details').disabled=true;
        connect(from.value, to.value);
      });
    };
    function connect(name,to) {
      const socket = io('http://localhost');
      socket.emit('join', {name,to} );
      socket.on('set messages', (data)=>{
        setMessages(data, name);
        console.log(data);
      });
      socket.on('set message', (data)=>{
        setNewMessage(data, name);
        console.log(data);
      });
      socket.on('connection success', () => {
        document.getElementById('send').disabled = false;
        const connectionStatus = document.getElementById('connection-status');

        function send(event) {
          const sendMessage = {
            from: document.getElementById('from').value,
            to: document.getElementById('to').value,
            message: document.getElementById('message').value,
            messageElt: document.getElementById('message'),
          };
          const { from, to, message, messageElt } = sendMessage;
          socket.emit('message', {
            to,
            message,
          });
          messageElt.value="";
          event.preventDefault();
        }
        
        document.getElementById('send-message').addEventListener('submit', send);
        connectionStatus.innerText = 'Connected to server';
      });
    }
  </script>
  
  </head>
  <body>
    <div class="container">
      <h1 id="connection-status">Connecting...</h1>
      <div class="row">
        <form class="col s12" id="details">
          <div class="input-field col s6">
            <label for="from">From</label>
            <input required type="text" value="" class="validate" id="from">
          </div>
          <div class="input-field col s6">
            <label for="to">To</label>
            <input required type="text" value="" class="validate" id="to">
          </div>
          <button class="btn waves-effect waves-light" type="submit" id="set-details">Lock details
            <i class="material-icons right">lock</i>
          </button>
        </form>
        
      </div>
      <div class="card">
        <div class="card-content black-text">
          <span class="card-title">Messages</span>
          <ul class="collection" id="message-container">
          </ul>
          <!-- <p>I am a very simple card. I am good at containing small bits of information.
          I am convenient because I require little markup to use effectively.</p> -->
        </div>
      </div>
      <div class="row">
        <form class="col s12" id="send-message">
          <div class="input-field col s12">
            <label for="message">Message</label>
            <textarea required type="text" class="materialize-textarea validate" value="" id="message"></textarea>
          </div>
          <button class="btn waves-effect waves-light" type="submit" name="action" id="send">Send
            <i class="material-icons right">send</i>
          </button>
        </form>
      </div>
    </div>
  </body>
</html>